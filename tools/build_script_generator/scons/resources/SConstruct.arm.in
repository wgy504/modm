#!/usr/bin/env python

import os

env = Environment(
        toolpath=['{{ toolpath }}'],
        tools=[
            'compiler_arm_none_eabi_gcc',
            'settings_buildpath',
            'utils_buildformat',
            'utils_buildsize',
            ],
        CCFLAGS_target=[
            '-mcpu={{ core }}',
            '-mthumb',
            '-mthumb-interwork',
            #'-mfloat-abi=softfp',
            #'-mfpu=fpv4-sp-d16',
            ],
        CFLAGS_language=['-std=gnu99'],
        ASFLAGS_target=[
            "-mcpu={{ core }}",
            "-mthumb",
        ],
        LINKFLAGS_target=[
            "-mcpu={{ core }}",
            "-mthumb",
            "-Llink",
            "-Tlinkerscript.ld",
            ],
        LINKFLAGS_optimize=[
            "-Wl,--relax",
            "-Wl,--gc-sections",
            "-Wl,-wrap,_malloc_r",
            "-Wl,-wrap,_calloc_r",
            "-Wl,-wrap,_realloc_r",
            "-Wl,-wrap,_free_r",
            "--specs=nano.specs",
            "-nostartfiles",
            ],
        ENV=os.environ)

env.RemoveFromList('CCFLAGS_warning', [
    '-Wshadow',
    '-Wcast-align',
    '-Wmissing-declarations',
    '-Wcast-qual',
    '-Wredundant-decls',])
env.RemoveFromList('CXXFLAGS_warning', [
    '-Wold-style-cast',
    '-Wnon-virtual-dtor'])
#env.Append(CCFLAGS_warning=['-Werror'])
env.Append(LINKFLAGS_other=['-Wl,--no-wchar-size-warning'])

env['BASEPATH']  = os.path.abspath('.')
env['BUILDPATH'] = os.path.abspath('build')

env.Append(CPPPATH=[
    'src',
    'ext',
    'ext/cmsis',
    'ext/cmsis_device',
])

files = env.Glob("*.cpp")
files += [
%% for file in files
    env.File("{{ file }}"),
%% endfor
]
program = env.Program(target='project.elf', source=files)

env.Alias('size', env.Size(program))
env.Alias('symbols', env.Symbols(program))

hexfile = env.Hex(program)

env.Alias('build', [hexfile, env.Listing(program)])
env.Alias('all', ['build', 'size'])

env.Default('build')
